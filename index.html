<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tienda de Gorras</title>
  <!-- Aquí puedes incluir tu CSS original si lo tienes -->
  <style>
    .section { display: none; }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <section id="login-section" class="section">
    <h2>Iniciar Sesión</h2>
    <form id="login-form">
      <label>Usuario:</label>
      <input type="text" id="username" required><br><br>
      <label>Contraseña:</label>
      <input type="password" id="password" required><br><br>
      <button type="submit">Ingresar</button>
    </form>
  </section>

  <!-- NAVEGACIÓN -->
  <div id="nav-buttons" style="display:none;">
    <button onclick="showSection('product-container')">Catálogo</button>
    <button onclick="showSection('pedidos')">Mis Pedidos</button>
    <button onclick="logout()">Cerrar Sesión</button>
  </div>

  <!-- PERFIL -->
  <div id="profile" style="display:none;">
    <p>Bienvenido, <strong id="profile-username"></strong></p>
    <p>Email: <span id="profile-email"></span></p>
  </div>

  <!-- CATÁLOGO DE PRODUCTOS -->
  <section id="product-container" class="section">
    <!-- Aquí se cargan los productos dinámicamente -->
  </section>

  <!-- VISTA DETALLE DEL PRODUCTO (GORRA) -->
  <section id="gorra-menu" class="section">
    <h2 id="gorra-title"></h2>
    <div id="gorra-list"></div>
  </section>

  <!-- LISTA DE PEDIDOS -->
  <section id="pedidos" class="section">
    <h2>Mis Pedidos</h2>
    <ul id="order-list"></ul>
  </section>

<script>
let currentUser = null;
window.onload = ()=> showSection('login-section');

// LOGIN
document.getElementById('login-form').addEventListener('submit', e=>{
  e.preventDefault();
  const u = document.getElementById('username').value,
        p = document.getElementById('password').value;
  fetch('login.php', {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.success){
      currentUser={ username: u, email: data.email, id: data.id };
      alert('¡Bienvenido '+u+'!');
      document.getElementById('profile-username').textContent = u;
      document.getElementById('profile-email').textContent = data.email;
      document.getElementById('nav-buttons').style.display = 'block';
      document.getElementById('profile').style.display = 'block';
      loadProducts();
      showSection('product-container');
    } else alert('Usuario o contraseña incorrectos');
  });
});

// CARGAR PRODUCTOS
function loadProducts(){
  fetch('cargar_productos.php')
    .then(r=>r.json())
    .then(arr=>{
      const cont = document.getElementById('product-container');
      cont.innerHTML = '<h2>Catálogo</h2>';
      arr.forEach(pr=>{
        cont.innerHTML += `
          <div class="product">
            <h3>${pr.nombre}</h3>
            <img src="imagenes/${pr.imagen}" width="100px">
            <p>Precio: $${parseFloat(pr.precio).toFixed(2)}</p>
            <button onclick="showProduct(${pr.id},'${pr.nombre}',${pr.precio})">Comprar</button>
          </div>`;
      });
    });
}

// MOSTRAR DETALLE DEL PRODUCTO
function showProduct(id, name, price){
  document.getElementById('gorra-title').textContent = name;
  document.getElementById('gorra-list').innerHTML = `
    <div class="product">
      <h3>${name}</h3>
      <p>Precio: $${price.toFixed(2)}</p>
      <label>Unidades: <input type="number" id="units" value="1" min="1"></label><br><br>
      <button onclick="buyNow(${id},'${name}',${price})">Confirmar</button>
    </div>`;
  showSection('gorra-menu');
}

// CONFIRMAR COMPRA
function buyNow(producto_id, nombre, precio){
  const unidades = parseInt(document.getElementById('units').value);
  const total = (precio * unidades).toFixed(2);
  fetch('guardar_pedido.php', {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`usuario_id=${currentUser.id}&producto_id=${producto_id}&unidades=${unidades}&total=${total}`
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.success){
      alert(`Pedido confirmado:\n${unidades} x ${nombre}\nTotal: $${total}\nEntrega: ${data.delivery}`);
      showSection('pedidos');
      loadOrders();
    } else alert('Error al guardar pedido');
  });
}

// CARGAR PEDIDOS
function loadOrders(){
  fetch(`ver_pedidos.php?usuario_id=${currentUser.id}`)
    .then(r=>r.json())
    .then(arr=>{
      const ol = document.getElementById('order-list');
      if(arr.length){
        ol.innerHTML = arr.map(o=>`
          <li class="order-item">
            <strong>${o.unidades} x ${o.nombre}</strong><br>
            Total: $${parseFloat(o.total).toFixed(2)}<br>
            Fecha de entrega: ${new Date(o.fecha_entrega).toLocaleDateString()}
          </li>`).join('');
      } else ol.innerHTML = '<li>No hay pedidos realizados.</li>';
    });
}

// MOSTRAR UNA SECCIÓN Y OCULTAR OTRAS
function showSection(id){
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

// CERRAR SESIÓN
function logout(){
  currentUser = null;
  document.getElementById('nav-buttons').style.display = 'none';
  document.getElementById('profile').style.display = 'none';
  document.getElementById('profile-username').textContent = '';
  document.getElementById('profile-email').textContent = '';
  showSection('login-section');
}
</script>

</body>
</html>

